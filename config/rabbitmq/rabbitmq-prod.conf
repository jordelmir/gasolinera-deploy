# RabbitMQ Production Configuration
# Optimized for high availability, performance, and reliability

# Listeners
listeners.tcp.default = 5672
management.tcp.port = 15672

# Logging
log.console = false
log.file = /var/log/rabbitmq/rabbit.log
log.file.level = info
log.file.rotation.date = $D0
log.file.rotation.size = 104857600  # 100MB
log.file.rotation.count = 10

# Memory Management
vm_memory_high_watermark.relative = 0.6
vm_memory_high_watermark_paging_ratio = 0.5
disk_free_limit.relative = 2.0

# Connection Management
heartbeat = 60
frame_max = 131072
channel_max = 2047
connection_max = 1000

# Default Virtual Host and User
default_vhost = gasolinera_vhost
default_user_tags.administrator = true

# Clustering
cluster_formation.peer_discovery_backend = classic_config
cluster_formation.classic_config.nodes.1 = rabbit@rabbitmq-primary
cluster_partition_handling = autoheal

# Management Plugin
management.rates_mode = basic
management.sample_retention_policies.global.minute = 5
management.sample_retention_policies.global.hour = 60
management.sample_retention_policies.global.day = 1200

# Statistics Collection
collect_statistics = coarse
collect_statistics_interval = 5000
management_agent.disable_metrics_collector = false

# Queue Settings
queue_master_locator = balanced
lazy_queue_explicit_gc_run_operation_threshold = 1000
queue_index_embed_msgs_below = 4096

# Message Store
msg_store_file_size_limit = 16777216
msg_store_credit_disc_bound = 4000

# Performance Tuning
tcp_listen_options.backlog = 128
tcp_listen_options.nodelay = true
tcp_listen_options.linger.on = true
tcp_listen_options.linger.timeout = 0
tcp_listen_options.exit_on_close = false
tcp_listen_options.keepalive = true

# High Availability
ha_promote_on_shutdown = when_synced
ha_promote_on_failure = when_synced

# Mirroring
mirroring_sync_batch_size = 4096

# SSL/TLS Configuration (if enabled)
# ssl_options.cacertfile = /etc/rabbitmq/ssl/ca_certificate.pem
# ssl_options.certfile = /etc/rabbitmq/ssl/server_certificate.pem
# ssl_options.keyfile = /etc/rabbitmq/ssl/server_key.pem
# ssl_options.verify = verify_peer
# ssl_options.fail_if_no_peer_cert = true
# ssl_options.versions.1 = tlsv1.2
# ssl_options.versions.2 = tlsv1.3

# Auth Mechanisms
auth_mechanisms.1 = PLAIN
auth_mechanisms.2 = AMQPLAIN

# Background GC
background_gc_enabled = true
background_gc_target_interval = 60000

# Proxy Protocol (if behind load balancer)
# proxy_protocol = true

# Plugins
plugins.directories.1 = /opt/rabbitmq/plugins
plugins.expand_criteria.1 = rabbitmq_management
plugins.expand_criteria.2 = rabbitmq_management_agent
plugins.expand_criteria.3 = rabbitmq_web_dispatch
plugins.expand_criteria.4 = rabbitmq_prometheus

# Prometheus Metrics
prometheus.tcp.port = 15692
prometheus.path = /metrics
prometheus.format = prometheus_text

# Shovel Plugin (for cross-datacenter replication)
# shovel.1.name = my_shovel
# shovel.1.src_uri = amqp://user:pass@source-host:5672/vhost
# shovel.1.dest_uri = amqp://user:pass@dest-host:5672/vhost
# shovel.1.src_queue = source_queue
# shovel.1.dest_queue = dest_queue

# Federation Plugin (for distributed messaging)
# federation.1.name = my_federation
# federation.1.uri = amqp://user:pass@upstream-host:5672/vhost
# federation.1.exchange = federated_exchange

# Trust Store (for SSL)
# ssl_cert_login_from = common_name
# ssl_cert_login_from = distinguished_name

# LDAP Authentication (if using LDAP)
# auth_backends.1 = ldap
# auth_backends.2 = internal
# auth_ldap.servers.1 = ldap-server
# auth_ldap.user_dn_pattern = cn=${username},ou=users,dc=example,dc=com
# auth_ldap.use_ssl = true
# auth_ldap.port = 636

# Disk Alarm
disk_free_limit.absolute = 2GB